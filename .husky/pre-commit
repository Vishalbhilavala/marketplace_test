#!/bin/bash
 
set -e
set -o pipefail
 
echo "üîç Running pre-commit checks..."
 
ALL_STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
echo "üìÇ All staged files:"
echo "$ALL_STAGED_FILES"
 
LINT_FILES=$(echo "$ALL_STAGED_FILES" | grep -E '\\.(ts|js|tsx|jsx)$' || true)
echo "üìÅ Lintable files:"
echo "$LINT_FILES"
 
ESLINT_EXIT_CODE=0
TSC_EXIT_CODE=0
CONSOLE_LOG_ERRORS=0
ANY_TYPE_ERRORS=0
COMMIT_MSG_ERRORS=0
UNUSED_EXPORT_ERRORS=0
SECRETS_FOUND=0
SONAR_ISSUES_FOUND=0
TESTS_EXIT_CODE=0
BUILD_EXIT_CODE=0
 
# Added:
FORMAT_EXIT_CODE=0
SPELL_EXIT_CODE=0
 
 
echo "üîß Running ESLint on staged JS/TS files with --max-warnings=0..."
 
ALL_LINT_FILES=$(git ls-files | grep -E '\\.(ts|js|tsx|jsx)$' | grep -v '^dist/' | grep -v 'eslint.config.js' | grep -v 'commitlint.config.ts' || true)
 
if [ -n "$ALL_LINT_FILES" ]; then
  echo "üîß Running ESLint on all JS/TS files in the repo with --max-warnings=0..."
  npx eslint $ALL_LINT_FILES --max-warnings=0 --no-warn-ignored || ESLINT_EXIT_CODE=$?
else
  echo "‚ÑπÔ∏è No JS/TS files found in repo for linting."
fi
 
 
  ### 3. Check for console.log ###
echo "üîé Searching for console.log in project files..."
CONSOLE_LOG_OUTPUT=$(grep -rnw --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" "console.log" ./src || true)
if [ -n "$CONSOLE_LOG_OUTPUT" ]; then
  echo "‚ùå console.log found:"
  echo "$CONSOLE_LOG_OUTPUT"
  CONSOLE_LOG_ERRORS=1
else
  echo "‚úÖ No console.log found."
fi
 
 
### 4. Check for usage of 'any' ###
echo "üîé Searching for usage of 'any' type in project files..."
 
ANY_USAGE=$(grep -Pnr --include="*.ts" --include="*.tsx" --exclude-dir="node_modules" '(?<!\/[/*]\s*)[:<]\s*any\b' ./src || true)
 
if [ -n "$ANY_USAGE" ]; then
  # Filter out lines where any usage is explicitly disabled
  FILTERED=$(echo "$ANY_USAGE" | grep -vE 'eslint-disable|ts-ignore|@ts-expect-error')
 
  if [ -n "$FILTERED" ]; then
    echo "‚ùå 'any' type usage found (excluding ignored lines):"
    echo "$FILTERED"
    ANY_TYPE_ERRORS=1
  else
    echo "‚úÖ All 'any' type usage is explicitly ignored."
  fi
else
  echo "‚úÖ No usage of 'any' type found."
fi
 
 
### Added: Prettier formatting check ###
echo "üßπ Checking code formatting with Prettier..."
npx prettier --check . || FORMAT_EXIT_CODE=$?
 
if [ $FORMAT_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Prettier formatting issues found!"
else
  echo "‚úÖ Prettier formatting clean."
fi
 
 
### Added: Spell check ###
if command -v cspell >/dev/null 2>&1; then
  echo "üî§ Running spell check (cspell)..."
  npx cspell "**/*.{ts,tsx,js,jsx,json,md}" || SPELL_EXIT_CODE=$?
 
  if [ $SPELL_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Spelling issues found!"
  else
    echo "‚úÖ No spelling issues detected."
  fi
else
  echo "‚ö†Ô∏è cspell not installed. Skipping spell check."
  SPELL_EXIT_CODE=0
fi
 
 
### 6. Run TypeScript compilation check (structural errors) ###
echo "üîß Checking for TypeScript structural issues..."
npx tsc --noEmit || TSC_EXIT_CODE=$?
if [ $TSC_EXIT_CODE -ne 0 ]; then
  echo "‚ùå TypeScript found structural errors!"
else
  echo "‚úÖ TypeScript structure valid."
fi
 
### 7. Secret detection with git-secrets ###
if command -v git-secrets >/dev/null 2>&1; then
  echo "üîí Running git-secrets scan..."
  if ! git secrets --scan; then
    echo "‚ùå Potential secrets detected!"
    SECRETS_FOUND=1
  else
    echo "‚úÖ No secrets detected."
  fi
else
  echo "‚ö†Ô∏è git-secrets not installed. Skipping secrets check."
fi
 
### 8. SonarScanner Check ###
echo "üì° Running SonarScanner..."
sonar-scanner > sonar_output.txt || true
 
if grep -qE "(BUG|VULNERABILITY|CODE_SMELL)" sonar_output.txt; then
  echo "‚ùå Sonar issues detected in the code!"
  grep -E "(BUG|VULNERABILITY|CODE_SMELL)" sonar_output.txt
  SONAR_ISSUES_FOUND=1
else
  echo "‚úÖ No Sonar issues detected."
  SONAR_ISSUES_FOUND=0
fi
 
# ### 9. Run all test cases ###
# TEST_FAILED=0
# TEST_FILES=$(git ls-files | grep -E '\\.(test|spec)\\.(ts|js|tsx|jsx)$' || true)
 
# ### 9. Run all test cases ###
# if [ -z "$TEST_FILES" ]; then
#   echo "‚ö†Ô∏è No test files found. Skipping test run."
# else
#   for test_file in $TEST_FILES; do
#     echo "‚û°Ô∏è Running test: $test_file"
#     npx jest "$test_file" --passWithNoTests
#     if [ $? -ne 0 ]; then
#       echo "‚ùå Failed: $test_file"
#       TEST_FAILED=1
#     else
#       echo "‚úÖ Passed: $test_file"
#     fi
#   done
 
#   if [ $TEST_FAILED -ne 0 ]; then
#     echo "üö´ One or more tests failed. Commit aborted!"
#     exit 1
#   else
#     echo "‚úÖ All tests passed. Proceeding with commit."
#   fi
# fi
 
 
### 9. Run all test cases (block commit on failure) ###
# echo "üß™ Running full test suite..."
# npm test --silent || TESTS_EXIT_CODE=$?
# if [ $TESTS_EXIT_CODE -ne 0 ]; then
#   echo "üö´ Tests failed. Commit aborted!"
# fi
 
 
### 10. Run build ###
echo "üèóÔ∏è Building the project..."
npm run build || BUILD_EXIT_CODE=$?
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Build failed!"
else
  echo "‚úÖ Build successful."
fi
 
 
### ‚úÖ Final decision ###
if [ $ESLINT_EXIT_CODE -ne 0 ] || \
   [ $TSC_EXIT_CODE -ne 0 ] || \
   [ $CONSOLE_LOG_ERRORS -ne 0 ] || \
   [ $ANY_TYPE_ERRORS -ne 0 ] || \
   [ $COMMIT_MSG_ERRORS -ne 0 ] || \
   [ $UNUSED_EXPORT_ERRORS -ne 0 ] || \
   [ $SONAR_ISSUES_FOUND -ne 0 ] || \
   [ $TESTS_EXIT_CODE -ne 0 ] || \
   [ $BUILD_EXIT_CODE -ne 0 ] || \
   [ $SECRETS_FOUND -ne 0 ] || \
   [ $FORMAT_EXIT_CODE -ne 0 ] || \
   [ $SPELL_EXIT_CODE -ne 0 ]; then
 
  echo "‚ùå Commit blocked due to pre-commit errors."
  exit 1
fi
 
echo "‚úÖ All checks passed. Proceeding with commit."
exit 0